# .github/workflows/ci-cd.yml

name: CI/CD Pipeline

# Disparadores: Cuándo se ejecuta este pipeline
on:
  push:
    branches: [ main ] # Se activa cuando haces 'git push' a la rama main
  pull_request:
    branches: [ main ] # También cuando abres un Pull Request hacia main

jobs:
  # --- FASE 1: TESTING (Integración Continua) ---
  testing:
    runs-on: ubuntu-latest # Se ejecutará en una máquina virtual de Linux
    steps:
      # 1. Descarga tu código del repositorio
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Configura el entorno de Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3. Instala las dependencias del proyecto
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Ejecuta los tests con cobertura (si esto falla, el pipeline se detiene)
      - name: Run tests with pytest
        run: pytest --cov=src

  # --- FASE 2: BUILD & PUSH (Entrega Continua) ---
  build-and-push:
    needs: testing # IMPORTANTE: Este trabajo solo se ejecuta si 'testing' fue exitoso
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' # Condición: solo en pushes directos a main
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write # Permiso clave para poder subir la imagen a GHCR

    steps:
      # 1. Descarga tu código
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Inicia sesión en el registro de contenedores de GitHub (GHCR)
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # Token automático que provee GitHub

      # 3. Obtiene el hash corto del commit para usarlo como tag de la imagen
      - name: Get commit hash
        id: commit
        uses: pr-mpt/actions-commit-hash@v2

      # 4. Construye la imagen Docker y la sube a GHCR
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ghcr.io/alesisneros14/sisnerosalexis_practicasre_lp:${{ steps.commit.outputs.short }}